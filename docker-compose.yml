services:
  mqtt-broker:
    image: eclipse-mosquitto
    container_name: mqtt-broker
    ports:
      - "${MQTT_PORT}:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    env_file:
      - .env

  id-server:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    container_name: id-server
    command: python -u id_server.py
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/5000"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  isccp:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    command: python -u isccp.py
    depends_on:
      id-server:
        condition: service_healthy
      mqtt-broker:
        condition: service_started
    deploy:
      replicas: 15
    environment:
      - TOTAL_INSTANCES=15
      - TOTAL_CARS=24
    env_file:
      - .env

  mongo1:
    image: mongo
    container_name: mongo1
    ports:
      - "27018:27017"
    volumes:
      - ./mongo_data_1:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo2:
    image: mongo
    container_name: mongo2
    ports:
      - "27019:27017"
    volumes:
      - ./mongo_data_2:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo3:
    image: mongo
    container_name: mongo3
    ports:
      - "27020:27017"
    volumes:
      - ./mongo_data_3:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  ssacp1:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    command: python -u sacp.py
    depends_on:
      mqtt-broker:
        condition: service_started
      mongo1:
        condition: service_healthy
    environment:
      - MONGO_HOST=mongo1
      - MONGO_DB=f1_db_1
    env_file:
      - .env

  ssacp2:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    command: python -u sacp.py
    depends_on:
      mqtt-broker:
        condition: service_started
      mongo2:
        condition: service_healthy
    environment:
      - MONGO_HOST=mongo2
      - MONGO_DB=f1_db_2
    env_file:
    
      - .env
  ssacp3:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    command: python -u sacp.py
    depends_on:
      mqtt-broker:
        condition: service_started
      mongo3:
        condition: service_healthy
    environment:
      - MONGO_HOST=mongo3
      - MONGO_DB=f1_db_3
    env_file:
      - .env

  car:
    build:
      context: ./sccp
      dockerfile: Dockerfile
    command: python -u car.py
    depends_on:
      - mqtt-broker
      - id-server
    deploy:
      replicas: 24
    env_file:
      - .env

  svcp:
    build:
      context: ./svcp
      dockerfile: Dockerfile
    container_name: svcp
    ports:
      - "${SVCP_PORT}:8000"
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    env_file:
      - .env

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "5173:5173"
    depends_on:
      - svcp
    environment:
      - VITE_API_BASE=http://svcp:8000